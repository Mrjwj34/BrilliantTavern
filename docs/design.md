
---

### **BrilliantTavern 项目架构设计文档**

#### **1. 概述**

本文档旨在详细说明 BrilliantTavern 项目的技术架构、模块划分以及核心设计思想。BrilliantTavern 是一个以 AI 角色扮演和语音对话为核心的 Web 社区平台，致力于为用户提供沉浸式、富有情感连接的交互体验。

作为项目的唯一开发者，我负责从架构设计、技术选型到前后端开发、部署与维护的全过程。

#### **2. 设计原则**

*   **单体应用优先:** 采用单体后端架构，降低开发部署复杂性，提高迭代效率。
*   **前后端分离:** 前端负责UI与交互，后端专注业务逻辑，通过API解耦。
*   **无状态后端:** 后端服务通过JWT认证实现无状态，会话由Redis集中管理，便于水平扩展。
*   **异步与响应式:** 针对AI和TTS等耗时I/O操作，采用异步和响应式编程，提升系统吞吐量。
*   **分层架构:** 遵循经典三层架构，职责清晰，结构明确。

#### **3. 整体架构图 **

```
+-----------------------------------------------------------------------------+
|                                  用户端 (Browser)                             |
|                                                                             |
|                                  [ 👤 用户 ]                                  |
+-----------------------------------------------------------------------------+
                                       |
                                       | (HTTPS)
                                       v
+-----------------------------------------------------------------------------+
|                            前端 (Frontend SPA - Vue 3)                        |
|-----------------------------------------------------------------------------|
| | Views (页面组件)  |  Components (可复用组件) |   API (数据服务)    | Utils  |
| |-------------------|--------------------------|---------------------|--------|
| | - Login.vue       | - CharacterCard.vue      | - request.js (axios)| - storage |
| | - Register.vue    | - CommentSection.vue     | - index.js (API集合)| - validation |
| | - Dashboard.vue   | - VoiceCard.vue          |                     | - tokenUtils |
| | - VoiceChat.vue   | - GlobalNotification.vue |                     | - notification |
| +---------------------------------------------------------------------------+
| | Router (路由管理) |      Assets (样式/静态资源)       |    main.js (入口)    |
+-----------------------------------------------------------------------------+
         |                      |                               |
 (REST API, WebSocket)          |                          (音频流)
         |                      v                               v
         +--------------------->|  [浏览器 API - MediaRecorder, AudioContext] |
                                +-------------------------------------------+
                                                      |
                                                      v
+-----------------------------------------------------------------------------+
|                        后端 (Backend - Spring Boot)                           |
|-----------------------------------------------------------------------------|
|                                                                             |
|  [ Controller (API入口) ] <-------------------------- [ WebSocket (实时通信) ] |
|            |                                                    |           |
|            +-------------------------+--------------------------+           |
|                                      v                                      |
|  +-----------------------------------------------------------------------+  |
|  |                      Service (核心业务逻辑层)                         |  |
|  +-----------------------------------------------------------------------+  |
|      |          |               |                 |             |          |
|      v          v               v                 v             v          |
| +----------+ +-------------+ +-------------+ +-----------+ +-------------+ |
| | Security | | Repository  | | Redis       | | TTS       | | Gemini      | |
| | (JWT)    | | (Data JPA)  | | (Cache/Sess)| | Service   | | Service     | |
| +----------+ +-------------+ +-------------+ +-----------+ +-------------+ |
|                    |               |                 |             |          |
|                    v               v                 v             v          |
+--------------------+---------------+-----------------+-------------+----------+
                     |               |                 |             |
                     v               v                 v             v
+--------------------+---------------+-----------------+-------------+----------+
| 数据存储 & 外部服务                                                          |
|-----------------------------------------------------------------------------|
|                                                                             |
| [🐘 PostgreSQL (+pgvector)] [💾 Redis] [🔊 TTS (FishSpeech)] [☁️ Google Gemini] |
|     (持久化数据/向量)       (缓存/会话)      (语音合成)     (LLM/RAG/Vision) |
+-----------------------------------------------------------------------------+

```

#### **4. 模块规格与职责 (前端更新)**

##### **4.1 前端架构 **

前端是一个基于 **Vue 3** 构建的单页应用，负责所有用户界面的渲染和交互逻辑。

*   **技术栈:**
    *   **框架:** Vue 3
    *   **语言:** JavaScript
    *   **路由:** Vue Router
    *   **HTTP客户端:** Axios
    *   **WebSocket客户端:** Stomp.js / SockJS
    *   **样式:** SCSS

*   **模块划分:**

| 目录/模块 | 核心文件/组件 | 主要职责 (Primary Responsibilities) |
| :--- | :--- | :--- |
| **`views` (页面级组件)** | `Login.vue`, `Register.vue`, `Dashboard.vue`, `VoiceChat.vue` | <li>定义了应用的主要页面视图，作为功能的顶层容器。</li><li>`Dashboard.vue` 是核心工作区，集成了角色市场、角色创建和语音对话等多个功能模块。</li><li>负责组合多个可复用组件，构建完整的用户界面。</li> |
| **`components` (可复用组件)** | `CharacterCard.vue`, `CharacterMarket.vue`, `CharacterCreator.vue`, `CommentSection.vue`, `VoiceCard.vue`, `RoundVoiceChat.vue` 等 | <li>构建了应用UI的原子和分子部分，实现了高度复用。</li><li>**业务组件:** 如 `CharacterMarket`、`CharacterCreator`、`CommentSection`，封装了完整的功能模块逻辑。</li><li>**展示组件:** 如 `CharacterCard`、`VoiceCard`，专注于数据的展示和基本交互。</li><li>**全局组件:** `GlobalNotification.vue` 提供全局消息通知能力。</li> |
| **`api` (API服务层)** | `index.js`, `request.js` | <li>`index.js` 将所有与后端API的交互按模块（如`authAPI`, `characterCardAPI`, `ttsAPI`）进行组织和导出，接口清晰。</li><li>`request.js` 是基于 Axios 封装的统一请求模块，配置了`baseURL`、`timeout`，并实现了**请求拦截器**（自动附加JWT Token）和**响应拦截器**（统一处理业务错误和HTTP状态码，如401自动跳转登录）。</li> |
| **`router` (路由管理)** | `index.js` | <li>使用 Vue Router 定义了所有页面的路由规则和访问权限。</li><li>通过路由元信息（`meta.requiresAuth`）和全局前置守卫（`beforeEach`）实现了**路由级别的认证拦截**，确保需要登录的页面在用户未认证时自动跳转到登录页。</li> |
| **`utils` (工具函数)** | `index.js`, `notification.js` | <li>`index.js` 提供了`storage`（封装localStorage操作）、`validation`（表单验证规则）、`tokenUtils`（JWT Token检查）、`debounce`（防抖）等通用工具函数。</li><li>`notification.js` 实现了一个全局、响应式的消息通知系统，支持成功、错误、警告等多种类型的提示。</li> |
| **`main.js` (应用入口)** | `main.js` | <li>应用的起点，负责创建Vue实例、挂载路由、导入全局样式，并注入`router`实例到`request.js`中，以便在API拦截器中执行路由跳转。</li> |
| **浏览器原生API** | (散布于各组件中) | <li>**`MediaRecorder`:** 在`RoundVoiceChat.vue`等组件中用于捕捉用户麦克风输入。</li><li>**`AudioContext` & `Blob`:** 用于处理和播放后端返回的音频流数据。</li> |

##### **4.2 后端架构 (Backend)**

后端基于 Spring Boot 构建，是一个职责清晰的单体应用。

*   **职责分工 (作为唯一开发者，我负责全部):**

| 模块 (Module) | 主要职责 (Primary Responsibilities) |
| :--- | :--- |
| **Controller (展现层)** | <li>作为API的统一入口，接收前端HTTP请求。</li><li>参数校验，并调用Service层处理业务。</li><li>返回统一格式的`ApiResponse`。</li> |
| **WebSocket (实时通信)** | <li>处理WebSocket连接、认证和消息路由。</li><li>`VoiceWebSocketController`接收实时语音数据，并调用核心协调器`StreamingVoiceOrchestrator`。</li> |
| **Service (业务逻辑层)** | <li>**核心业务:** 实现用户认证、角色卡管理、评论、点赞、音色管理等所有核心功能。</li><li>**AI编排:** `StreamingVoiceOrchestrator`是语音对话的“总指挥”，它协调`AIService`（LLM交互）、`TTSManagerService`（语音合成）、`CharacterMemoryService`（RAG记忆）和`ImageGenerationService`（文生图），实现复杂的流式对话体验。</li><li>**外部服务集成:** 封装对Google Gemini和FishSpeech TTS服务的调用逻辑，包括重试和错误处理。</li><li>**数据库事务管理:** 使用`@Transactional`确保数据一致性。</li> |
| **Repository (数据访问层)** | <li>定义与数据库交互的接口（JPA），屏蔽底层数据源细节。</li> |
| **Security (安全模块)** | <li>基于Spring Security和JWT实现用户认证和API授权。</li> |
| **配置与实体 (Config & Entities)** | <li>**Configuration:** 集中管理应用配置，如数据库连接、Redis、外部服务API Key等。</li><li>**Entities & DTOs:** 定义数据库实体和用于API数据传输的对象。</li> |

#### **5. 数据存储**

*   **PostgreSQL (主数据库):**
    *   **职责:** 存储所有持久化数据（用户、角色卡、聊天历史等）。
    *   **我选择它的原因:** 利用其**`pgvector`**扩展，将关系型数据和向量数据（用于RAG）统一存储，简化了技术栈，无需额外维护向量数据库。

*   **Redis (缓存与会话存储):**
    *   **职责:**
        1.  **应用缓存:** 缓存TTS测试音频等，降低延迟。
        2.  **会话管理:** 存储活跃的语音聊天会话信息，使后端服务无状态。
        3.  **对话历史缓存:** 供AI模型快速获取上下文。

#### **6. 外部服务集成**

*   **Google Gemini (Vertex AI):**
    *   **职责:** 作为项目的大脑，负责核心对话生成、RAG的文本嵌入和多模态的文生图能力。
*   **TTS 服务 (FishSpeech):**
    *   **职责:** 作为项目的声音，负责将AI生成的文本实时转换为富有表现力的语音，并支持音色克隆。

#### **7. 职责分工**

作为该项目的唯一开发者，我承担了以下所有职责：

*   **产品与设计:** 负责需求分析、功能规划和用户故事编写。
*   **架构设计:** 负责整体技术架构的设计、技术选型和模块划分。
*   **后端开发:** 负责所有后端模块的编码、测试和维护。
*   **前端开发:** 负责所有前端界面的开发与交互逻辑实现。
*   **运维与部署:** 负责项目的打包、部署、监控和维护工作。