# 语音对话功能设计文档

## 1. 功能概述

### 1.1 项目背景
为BrilliantTavern角色卡系统增加语音对话功能，提供更加沉浸式的AI角色交互体验。通过语音输入和语音输出，用户可以与自己创建或点赞的角色卡进行实时语音对话。

### 1.2 核心目标
- 实现极低延迟的语音对话体验
- 支持流式音频生成，提升用户感知的响应速度
- 提供直观易用的语音交互界面
- 确保音频质量和对话连贯性

### 1.3 工作流程概览
1. 用户点击"语音对话"进入功能页面
2. 系统展示可用角色卡列表（用户点赞的和自己创建的）
3. 用户选择目标角色卡
4. 进入语音聊天界面
5. 用户录制语音 → Gemini模型直接处理音频 → 流式生成文本 → 分段TTS转换 → 前端播放

## 2. 技术架构设计

### 2.1 系统架构
- **前端层**：Vue.js + WebRTC/MediaRecorder API
- **后端层**：Spring Boot + WebSocket
- **AI服务层**：Google Gemini API + TTS服务
- **存储层**：数据库 + 临时音频文件存储

### 2.2 核心技术栈
- **音频录制**：MediaRecorder API
- **实时通信**：WebSocket
- **AI模型**：Google Gemini (支持音频输入)
- **TTS服务**：待定（可以确定的是通过restful api调用, 暂时给出fake实现）
- **音频播放**：Web Audio API
- **流式处理**：服务端流式响应 + 前端分段处理

### 2.3 延迟优化策略
1. **跳过ASR步骤**：直接将音频传输给Gemini模型
2. **流式文本生成**：按标点符号分割文本段落
3. **并行TTS处理**：文本段生成后立即进行TTS转换
4. **音频预加载**：前端接收到音频片段后立即准备播放
5. **连接复用**：维持WebSocket长连接减少握手开销

## 3. 详细功能设计

### 3.1 角色卡选择页面

#### 3.1.1 功能特性
- 展示用户有权限访问的角色卡（自己创建的 + 点赞的）
- 支持角色卡搜索和筛选
- 显示角色卡基本信息（头像、名称、简介）

#### 3.1.2 数据来源
- 查询用户创建的角色卡
- 查询用户点赞的公开角色卡

#### 3.1.3 交互设计
- 卡片式布局展示角色列表
- 点击角色卡显示详细信息弹窗
- 提供"开始语音对话"按钮
- 支持返回主页面功能

### 3.2 语音聊天界面

#### 3.2.1 界面布局
- **顶部区域**：角色信息展示（头像、名称、状态指示器）
- **中央区域**：对话历史展示（文字+语音波形可视化）
- **底部区域**：语音控制按钮（录音、停止、设置）
- **侧边栏**：对话设置（可选，包括语速、音量等, llmAPi配置, tts服务配置）

#### 3.2.2 状态管理
- **空闲状态**：等待用户输入
- **录音状态**：正在录制用户语音
- **处理状态**：服务端处理中（显示加载动画）
- **播放状态**：AI回复音频播放中
- **错误状态**：网络错误或服务异常

#### 3.2.3 交互方式
- **按住录音**：长按录音按钮进行语音输入
- **点击录音**：点击开始录音，再次点击结束
- **语音可视化**：录音和播放时显示音频波形
- **手动中断**：用户可中断AI播放开始新对话

### 3.3 语音处理流程

#### 3.3.1 用户语音输入处理
1. **录音启动**：用户触发录音，前端开始音频采集
2. **实时上传**：录音过程中实时上传音频数据块
3. **录音结束**：用户结束录音，发送完整音频文件
4. **格式转换**：确保音频格式符合Gemini API要求

#### 3.3.2 AI响应生成
1. **音频直传**：将用户音频直接发送给Gemini模型
2. **上下文注入**：结合角色卡信息和对话历史
3. **流式生成**：Gemini流式输出文本响应
4. **分段处理**：按句号、问号、感叹号等标点分割文本

#### 3.3.3 TTS转换与播放
1. **文本分段**：将AI响应按语义分割为音频段落
2. **并行转换**：多个文本段同时进行TTS处理
3. **音频排队**：按序列将音频片段加入播放队列
4. **连续播放**：前端无缝播放音频片段序列

## 4. 接口设计

### 4.1 REST API接口

#### 4.1.1 获取可用角色卡列表
- **接口路径**：`GET /api/voice/available-characters`
- **请求参数**：用户认证信息
- **响应数据**：角色卡列表（包含ID、名称、头像、简介、TTS配置）
- **业务逻辑**：查询用户创建的+点赞的角色卡，过滤TTS配置

#### 4.1.2 获取角色卡语音配置
- **接口路径**：`GET /api/voice/character/{id}/config`
- **请求参数**：角色卡ID
- **响应数据**：TTS语音配置信息
- **业务逻辑**：返回角色的语音设置和特征参数

#### 4.1.3 创建语音对话会话
- **接口路径**：`POST /api/voice/sessions`
- **请求参数**：角色卡ID、用户ID
- **响应数据**：对话会话ID、WebSocket连接信息
- **业务逻辑**：初始化对话上下文，创建会话记录

### 4.2 WebSocket接口

#### 4.2.1 连接建立
- **连接路径**：`/ws/voice/{sessionId}`
- **认证方式**：Token验证或Session验证
- **连接参数**：会话ID、用户认证信息

#### 4.2.2 消息类型定义

**用户音频输入消息**
- **消息类型**：`AUDIO_INPUT`
- **数据格式**：Base64编码音频数据 + 元数据
- **元数据包含**：音频格式、采样率、时长

**AI文本响应消息**
- **消息类型**：`TEXT_RESPONSE`
- **数据格式**：文本内容 + 分段信息
- **状态标识**：是否为完整响应结束

**TTS音频响应消息**
- **消息类型**：`AUDIO_RESPONSE`
- **数据格式**：Base64编码音频数据 + 播放序号
- **控制信息**：是否为最后一个音频片段

**状态控制消息**
- **消息类型**：`STATUS_UPDATE`
- **状态类型**：处理中、错误、完成等
- **错误信息**：具体错误描述（如有）

### 4.3 第三方服务集成

#### 4.3.1 Gemini API集成
- **音频输入格式**：支持的音频编码格式
- **上下文管理**：角色设定 + 对话历史
- **流式响应**：处理Gemini的流式输出
- **错误处理**：API限流、超时、格式错误等

#### 4.3.2 TTS服务集成
- **服务选型**：评估延迟、质量、成本因素
- **语音配置**：音色、语速、音调参数
- **批处理优化**：文本分段并行处理
- **缓存策略**：常用短语音频缓存

## 5. 数据模型设计

### 5.1 语音对话会话表
- **会话ID**：唯一标识
- **用户ID**：对话发起者
- **角色卡ID**：选择的角色
- **创建时间**：会话开始时间
- **更新时间**：最后活跃时间
- **状态**：活跃、已结束、异常
- **配置信息**：TTS参数等

### 5.2 对话记录表
- **记录ID**：唯一标识
- **会话ID**：关联的对话会话
- **消息类型**：用户语音、AI文本、AI音频
- **内容数据**：音频文件路径或文本内容
- **时间戳**：消息生成时间
- **元数据**：音频时长、文件大小等

### 5.3 角色TTS配置表
- **角色ID**：关联角色卡
- **TTS服务商**：使用的TTS服务
- **语音ID**：具体的语音模型
- **参数配置**：语速、音调、音量等
- **创建时间**：配置创建时间
- **更新时间**：最后修改时间

## 6. 性能优化方案

### 6.1 延迟优化
1. **音频压缩**：客户端录音时使用高效压缩格式
2. **分块上传**：大音频文件分块传输
3. **预连接**：提前建立到AI服务的连接
4. **本地缓存**：缓存常用角色的TTS配置
5. **CDN加速**：音频文件通过CDN分发

### 6.2 并发处理
1. **异步处理**：所有IO操作使用异步模式
2. **线程池**：合理配置TTS处理线程池
3. **连接池**：复用到第三方服务的连接
4. **队列机制**：高并发时使用消息队列缓冲

### 6.3 资源管理
1. **音频清理**：定期清理过期的临时音频文件
2. **会话管理**：自动清理超时的WebSocket连接
3. **内存优化**：及时释放大音频文件占用的内存
4. **数据库优化**：对话记录表的索引和分表策略

## 7. 错误处理与异常情况

### 7.1 网络异常处理
- **连接断开**：WebSocket重连机制
- **传输失败**：音频数据重传机制
- **超时处理**：各个环节的超时设置和降级方案

### 7.2 服务异常处理
- **Gemini API异常**：备用模型或错误提示
- **TTS服务异常**：降级到纯文本模式
- **存储异常**：临时文件系统故障处理

### 7.3 用户体验保障
- **音频质量检测**：录音质量过低时提醒重录
- **网络状况提示**：网络不佳时给出延迟预警
- **降级模式**：在语音功能异常时切换到文字聊天

## 8. 安全性考虑

### 8.1 数据安全
- **音频加密**：传输过程中的音频数据加密
- **临时文件**：定期清理用户音频文件
- **访问控制**：确保用户只能访问自己的对话记录

### 8.2 隐私保护
- **数据最小化**：只保存必要的对话数据
- **用户同意**：明确告知音频数据的使用目的
- **数据删除**：提供用户删除历史对话的功能

### 8.3 防滥用机制
- **频率限制**：单用户语音对话频率限制
- **时长限制**：单次录音时长上限
- **内容过滤**：对AI响应内容的安全性检查

## 9. 监控与运维

### 9.1 性能监控
- **延迟监控**：各环节的响应时间统计
- **成功率监控**：语音处理成功率统计
- **资源监控**：CPU、内存、存储空间监控

### 9.2 业务监控
- **用户活跃度**：语音对话功能使用情况
- **角色热度**：各角色卡的语音对话次数
- **错误统计**：各类异常的发生频率和原因

### 9.3 运维支持
- **日志管理**：结构化日志记录和检索
- **告警机制**：关键指标异常时的告警通知
- **容量规划**：基于使用情况的资源扩容预案

## 10. 实施计划

### 10.1 开发阶段
1. **Phase 1**：基础架构搭建（WebSocket、音频处理）
2. **Phase 2**：Gemini API集成和TTS服务对接
3. **Phase 3**：前端语音界面开发
4. **Phase 4**：流式处理和性能优化
5. **Phase 5**：测试、调优和上线

### 10.2 测试策略
- **单元测试**：各个服务组件的功能测试
- **集成测试**：端到端的语音对话流程测试
- **性能测试**：延迟、并发、稳定性测试
- **用户体验测试**：实际场景下的用户体验评估

### 10.3 上线计划
- **灰度发布**：小规模用户群体优先体验
- **监控观察**：密切关注系统性能和用户反馈
- **逐步放量**：根据系统稳定性逐步扩大用户范围
- **功能迭代**：基于用户反馈持续改进功能体验

---

**文档版本**：v1.0  
**创建日期**：2025年9月23日  
**最后更新**：2025年9月23日  
**文档状态**：待评审
