# Brilliant Tavern 语音对话功能设计

## 1. 目标与范围
- 为角色卡驱动的语音聊天提供端到端支撑，覆盖角色卡选择、语音会话、对话存档等核心流程。
- 在首字延迟内压缩到「网络传输 + 服务端处理 + Gemini 首句生成 + TTS 首句输出」，用户端显著感知为实时互动。
- 使用 Gemini 系列模型直接接收音频输入，跳过传统 ASR，服务端负责流式文本生成与 TTS 调度。
- 提供可扩展的接口与模块分层，后续可插拔替换模型、TTS、缓存或分析能力。
- 本稿聚焦于功能设计与接口约定，不包含具体代码实现。

## 2. 用户体验流程
1. 用户点击语音对话入口，前端展示「点赞的」与「自建」角色卡，支持检索和分页。
2. 用户选择角色卡后进入语音聊天界面，建立 WebSocket 连接并完成媒体权限校验。
3. 前端开始采集用户语音，按 200ms 左右的分片推送给后端。
4. 后端将音频流传入 Gemini，实时获得分段文本；按句号、问号、逗号等标点切分后逐块推送到 TTS 服务。
5. TTS 返回的音频切片经后端合流后回推给前端，前端基于 MSE/Web Audio 连续播放。
6. 会话过程中展示 Gemini 生成的文本字幕，支持打断、重播、收尾归档。
7. 会话结束时生成 session 小结，存入历史记录，供后续回放或继续对话。

## 3. 整体架构设计
- **前端 (Vue 3 SPA)**
  - 新增 Voice Chat 视图与组件，用于角色卡列表、语音通话面板、字幕和控制栏。
  - 负责音频采集、波形显示、字幕呈现、WebSocket 收发与状态管理。
- **后端 (Spring Boot)**
  - REST 层：角色卡查询、语音对话会话管理、历史记录。
  - WebSocket 层：全双工语音会话通道，处理音频分片、模型响应、TTS 音频回传。
  - Service 层：音频缓冲、Gemini Streaming Client、TTS Dispatcher、会话状态机。
  - Infrastructure：任务队列（消息队列如redis stream）、缓存 (Redis) 提升流式吞吐。
- **外部服务**
  - Gemini 2.5 Streaming API：直接提交音频分片，获取流式文本或多模态响应。
  - TTS 服务（Fish Speech/自建服务）：接收短文本切片，返回可合成的语音片段，支持 streaming。
  - 存储：PostgreSQL 用于会话/角色/配置持久化。
